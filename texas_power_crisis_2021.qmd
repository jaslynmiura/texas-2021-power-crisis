---
title: "Texas Power Crisis, February 2021"
author: "Jaslyn Miura"
format: html
date: October 24, 2025
---

```{r}
library(terra) # raster handling
library(tidyverse)
library(tmap) # map making
library(kableExtra) # table formatting
library(spData) # spatial data
library(spDataLarge) # spatial data
library(geodata) # spatial data
library(stars)
library(sf)
```


```{r}

# create raster objects
houston1 <- rast("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif")
houston2 <- rast("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif")
houston3 <- rast("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif")
houston4 <- rast("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif")

roads <- st_read("data/gis_osm_roads_free_1.gpkg")
houses <- st_read("data/gis_osm_buildings_a_free_1.gpkg")
socioeconomic <- st_read("data/ACS_2019_5YR_TRACT_48_TEXAS.gdb")

```

# Checking the CRS of the rasters

```{r}
if(st_crs(houston1) == st_crs(socioeconomic)){
  print("it's a match!")
} else {
  print("crs does not a match")
}

socioeconomic <- st_transform(socioeconomic, crs = st_crs(houston1))
```

```{r}

day_1 <- merge(houston1, houston2)
day_2 <- merge(houston3, houston4)

# find the change in night lights intensity (presumably) caused by the storm
# hint: this will require creating a raster object for each day (2021-02-07 and 2021-02-16)
difference <- (day_2 - day_1)

```

```{r}
tm_shape(day_1) + 
  tm_raster(col.legend = tm_legend("Power?")) + 
  
```

```{r}

# Define a reclassification matrix
rcl <- matrix(c(-Inf, 200, 0, # values -Inf to 199 = 0
                200, Inf, 1),  # values 200 to Inf = 1
              ncol = 3, byrow = TRUE)

# Apply the matrix to reclassify the raster, making all cells 0 or 1 or 2
day1_rcl <- terra::classify(day_1, rcl = rcl)

# # Assign labels to the numerical categories
# levels(dem_rcl) <- tibble::tibble(id = 0:2, 
#                                   cats = c("low", "medium", "high"))

 values(day1_rcl) <- as.factor(values(day1_rcl))

tm_shape(day1_rcl) +
  tm_raster()

```

reclassify the difference raster, assuming that any location that experienced a drop of more than 200 nW cm-2sr-1 experienced a blackout
```{r}

# Define a reclassification matrix
rcl <- matrix(c(-Inf, 200, 0, # values -Inf to 199 = 0
                200, Inf, 1),  # values 200 to Inf = 1
              ncol = 3, byrow = TRUE)

# Apply the matrix to reclassify the raster, making all cells 0 or 1 or 2
difference_rcl <- terra::classify(difference, rcl = rcl)

# # Assign labels to the numerical categories
# levels(dem_rcl) <- tibble::tibble(id = 0:2, 
#                                   cats = c("low", "medium", "high"))

 values(difference_rcl) <- as.factor(values(difference_rcl))

tm_shape(difference_rcl) +
  tm_raster()


```

assign NA to all locations that experienced a drop of less than 200 nW cm-2sr-1 change
```{r}

# create raster mask of the same resolution and extent
rmask <- difference

# set all cells with  less than 200 to NA
rmask[rmask < 200] <- NA

# approach 2: mask() function
masked <- mask(difference, rmask) 

tm_shape(masked) +
  tm_raster()

```

vectorize the blackout mask
hint: use st_as_sf() to convert from a raster to a vector and fix any invalid geometries with st_make_valid()
```{r}

masked_sf <- st_as_sf(masked) %>% 
  st_make_valid()

```

